// @bun
var{plugin:a}=globalThis.Bun;import{cc as r,FFIType as O}from"bun:ffi";var t=function(){let H={"=":1,"+=":1,"-=":1,"*=":1,"/=":1,"%=":1,">>=":1,"<<=":1,"&=":1,"^=":1,"|=":1,"?":2,":":2,"||":3,"&&":4,"|":5,"^":6,"&":7,"<":8,">":8,"<=":8,">=":8,"==":8,"!=":8,">>":9,"<<":9,"+":10,"-":10,"*":11,"/":11,"%":11,".":13,"->":13};var G=Object.keys(H);G.sort(function(j,q){return q.length-j.length});let V={"++":12,"--":12,"!":12,"~":12,"&":12,"*":12,"+":12,"-":12,sizeof:12},X={"++":13,"--":13},W={"1":!0,"2":!0,"12":!0},Y={a:"a",b:"\b",f:"\f",n:`
`,r:"\r",t:"\t",v:"\v","\\":"\\","'":"'",'"':'"',"?":"?"},J=["void","char","short","int","long","float","double"],Z=["signed","unsigned","short","long","const","struct","enum","static","extern","inline","volatile"];return function(j,q){var _,b=-1;q=q||{};var Q=q.types||J.slice(0),U=q.modifier||Z.slice(0),C={line:1,file:q.file||"unknown"};function E(){Q.sort(function(F,T){return T.length-F.length}),U.sort(function(F,T){return T.length-F.length})}return E(),z(),n();function n(){var F=[];while(_){var T=K();if(g(),w("struct")){var I={type:"StructDefinition",member:[],pos:T};I.name=N(),y("{");while(v()){var $=M();I.member.push($),y(";")}y("}"),Q.push(I.name),E(),F.push(I)}else if(w("enum")){var I={type:"EnumDefinition",member:[],pos:T};I.name=N(),y("{");while(m())if(I.member.push(N()),!w(","))break;y("}"),Q.push(I.name),E(),F.push(I)}else if(w("typedef")){var $=M();$.type="TypeDefStatement",$.pos=T,Q.push($.name),E(),y(";"),F.push($)}else if(v()){var $=M();if($.pos=T,w("(")){if($.arguments=p(),w(";"))$.type="FunctionDefinition";else $.type="FunctionDeclaration",$.body=D();F.push($)}else{if(w("="))$.value=L(";");else y(";");$.type="GlobalVariableDeclaration",F.push($)}}else P("struct, enum, typdef, extern, FunctionDeclaration or VariableDeclaration")}return F}function p(){var F=[];while(v()){if(F.push(M()),w(")"))return F;y(",")}return y(")"),F}function D(){var F=[];y("{");while(!(_=="}"||!_)){var T=K(),I=h();F.push(I)}return y("}"),F}function h(){var F=K();if(w("return"))return{type:"ReturnStatement",value:L(";"),pos:F};else if(w("if")){y("(");var T={type:"IfStatement",pos:F};if(T.condition=L(")"),T.body=D(),w("else"))T.else=D();return T}else if(w("while"))return y("("),{type:"WhileStatement",condition:L(")"),body:D(),pos:F};else if(w("do")){var T={type:"DoWhileStatement",pos:F};return T.body=D(),y("while"),y("("),T.condition=L(")"),y(";"),T}else if(w("for")){var T={type:"ForStatement",pos:F};return y("("),T.init=h(),T.condition=L(";"),T.step=L(")"),T.body=D(),T}else if(v()){var I=M();if(w("="))I.value=L(";");else y(";");return I.type="VariableDeclaration",I.pos=F,I}else return{type:"ExpressionStatement",expression:L(";"),pos:F}}function L(F){var T=f(B(),0);if(F)y(F);return T}function S(){var F=b;for(var T=0;T<G.length;T++)if(w(G[T]))return b=F,_=j[b],G[T]}function f(F,T){var I=S();while(I&&H[I]>=T){var $=I,A=K();y($);var R=B();I=S();while(I&&H[I]>H[$])R=f(R,H[I]),I=S();F={type:"BinaryExpression",operator:$,left:F,right:R,pos:A}}return F}function B(){var F,T=K();for(var I in V)if(w(I))return{type:"PrefixExpression",operator:I,value:B(),pos:T};if(w("("))if(v())F={type:"CastExpression",targetType:M(!0)},y(")"),F.value=B();else F=L(")");else if(w("{")){var $=[];while(_)if($.push(L()),!w(","))break;y("}"),F={type:"Literal",value:$}}else if(w("'")){var A=_.charCodeAt(0);if(_=="\\")A=u().charCodeAt(0);else z(!0,!0);y("'"),F={type:"Literal",source:"CharCode",value:A}}else if(o())F={type:"Literal",value:l()};else if(i())F={type:"Literal",value:k()};else if(m()){var A=N();F={type:"Identifier",value:A}}else return;if(w("[")){var R=L();y("]"),F={type:"IndexExpression",value:F,index:R}}else if(w("(")){var c=[];while(_)if(c.push(L()),!w(","))break;y(")"),F={type:"CallExpression",base:F,arguments:c}}F.pos=T;var d=K();for(var I in X)if(w(I))return{type:"SuffixExpression",operator:I,value:F,pos:d};return F}function v(){var F=b;for(var T=0;T<U.length;T++)if(w(U[T]))return b=F,_=j[b],!0;for(var T=0;T<Q.length;T++)if(w(Q[T]))return b=F,_=j[b],!0}function M(F){var T,I=K(),$={type:"Type",modifier:[],pos:K()};do{var A=!1;for(var R=0;R<U.length;R++)if(w(U[R]))$.modifier.push(U[R]),A=!0}while(A);for(var R=0;R<Q.length;R++)if(w(Q[R])){$.name=Q[R];while(w("*"))$={type:"PointerType",target:$,pos:K()};if(!F)T=N();while(w("["))if($={type:"PointerType",target:$,pos:K()},!w("]"))$.length=L(),y("]");if(T)$={type:"Definition",defType:$,name:T,pos:I};return $}P(Q.join(", "))}function o(){return _&&_=='"'}function l(F){var T=[];z(!0,!0);while(_&&_!='"')if(_=="\\")z(!0,!0),T.push(u());else T.push(_),z(!0,!0);if(!w('"',F))P('"');return T.join("")}function u(){if(_=="x"){z(!0,!0);var F=0;while(/[0-9A-Fa-f]/.test(_))F=(F<<4)+parseInt(_,16),z(!0,!0);return String.fromCharCode(F)}else if(/[0-7]/.test(_)){var F=0;while(/[0-7]/.test(_))F=(F<<3)+parseInt(_,16),z(!0,!0);return String.fromCharCode(F)}else if(Y[_]){var T=Y[_];return z(!0,!0),T}P("escape sequence")}function i(){return _&&/[0-9]/.test(_)}function k(F){var T=x(/[0-9\.]/,"Number",/[0-9]/,F);return parseFloat(T)}function m(){return _&&/[A-Za-z_]/.test(_)}function N(F){return x(/[A-Za-z0-9_]/,"Identifier",/[A-Za-z_]/,F)}function x(F,T,I,$){if(I=I||F,!I.test(_))P(T);var A=[_];z(!0);while(_&&F.test(_))A.push(_),z(!0);if(!$)g();return A.join("")}function K(){return{file:C.file,line:C.line}}function P(F){var T=K(),I=JSON.stringify(_||"EOF"),$=[T.file,":",T.line,": Expecting ",JSON.stringify(F)," got ",I].join("");throw console.error($),new Error($)}function w(F,T){var I=b;for(var $=0;$<F.length;$++){if(_!=F[$])return b=I,_=j[b],!1;z(!0)}if(/^[_a-zA-Z][_a-zA-Z0-9]*$/.test(F)&&/[_a-zA-Z]/.test(_))return b=I,_=j[b],!1;if(!T)g();return!0}function y(F){for(var T=0;T<F.length;T++){if(_!=F[T])P(F);z()}}function g(){if(/[\s\n]/.test(_))z()}function z(F,T){if(F=F||!1,_==`
`)C.line++;b++,_=j[b];do{var I=R()||A();if(!F&&(b==0||j[b-1]==`
`)&&_=="#"){y("#");var $=C.line=k(!0)-1;y(" "),C.file=l(!0);while(_!=`
`)b++,_=j[b];I=!0}}while(I);function A(){if(F)return;if(/[\s\n]/.test(_)){while(_&&/[\s\n]/.test(_)){if(_==`
`)C.line++;b++,_=j[b]}return!0}}function R(){if(T)return;if(_&&_=="/"&&j[b+1]=="/"){while(_!=`
`)b++,_=j[b];return!0}if(_&&_=="/"&&j[b+1]=="*"){while(_!="*"||j[b+1]!="/"){if(_==`
`)C.line++;b++,_=j[b]}return b+=2,_=j[b],!0}}}}}();var s={name:"bun-plugin-c",target:"bun",setup:function(H){H.onLoad({filter:/\.c$/},async(G)=>{let V=await FF(G.path),{symbols:X}=r({source:G.path,symbols:V}),W=TF(V);return console.info(`
Imported ${G.path} with following functions:

import _lib from "${G.path}";

interface lib {
${W}}

const lib = _lib as lib;

`),{exports:{__types:W,...X,default:X},loader:"object"}})}},e=await a(s);var yF=e;async function FF(H){let V=(await Bun.file(H).text()).replaceAll(/#include\s*<.*>/g,""),X=t(V,{file:H}),W={};function Y(J){if(J.type==="PointerType")return O.ptr;switch(J.name){case"int":return O.int;case"float":return O.float;case"double":return O.double;case"void":return O.void;default:return O.ptr}}for(let J of X)if(J.type==="FunctionDeclaration"||J.type==="FunctionDefinition")W[J.name]={args:(J.arguments||[]).map((Z)=>Y(Z.defType)),returns:Y(J.defType)};return W}function TF(H){let G={0:"FFIType.char",1:"FFIType.int8_t",2:"FFIType.uint8_t",3:"FFIType.int16_t",4:"FFIType.uint16_t",5:"FFIType.int32_t",6:"FFIType.uint32_t",7:"FFIType.int64_t",8:"FFIType.uint64_t",9:"FFIType.double",10:"FFIType.float",11:"FFIType.bool",12:"FFIType.ptr",13:"FFIType.void",14:"FFIType.cstring",15:"FFIType.i64_fast",16:"FFIType.u64_fast",17:"FFIType.function",18:"FFIType.napi_env",19:"FFIType.napi_value",20:"FFIType.buffer"},V="";for(let[X,W]of Object.entries(H)){let Y=W.args.map((Z)=>G[Z]||"unknown").map((Z,j)=>`_${j}: `+Z).join(", "),J=G[W.returns]||"unknown";V+=`${X}(${Y}): ${J};
`}return V}export{yF as default,e as c_plugin};
